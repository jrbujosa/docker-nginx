<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chef As√≠ncrono y Event Loop (Paso a Paso con Explicaciones)</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            background-color: #f4f4f4;
            padding-bottom: 150px; /* Espacio para la explicaci√≥n fija */
        }
        .container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            width: 90%;
            max-width: 1000px;
            margin-bottom: 20px;
        }
        .chef-area, .event-loop-visualizer {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .chef-area {
            flex: 1;
            text-align: center;
        }
        .event-loop-visualizer {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .box {
            border: 1px solid #ccc;
            padding: 10px;
            min-height: 80px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .box h3 {
            margin-top: 0;
            font-size: 1.1em;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        .task-item {
            background-color: #e0e0e0;
            padding: 5px 8px;
            margin-bottom: 5px;
            border-radius: 3px;
            font-size: 0.9em;
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chef-image {
            width: 100px;
            height: 100px;
            background-color: #ddd;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            transition: transform 0.3s, background-color 0.3s;
        }
        .chef-image.active {
            transform: scale(1.1);
            background-color: #a7c7e7;
        }
        .thought-bubble {
            display: none;
            position: relative;
            background: #fff;
            border-radius: .4em;
            padding: 10px;
            margin: 10px auto;
            border: 1px solid #ccc;
            width: fit-content;
        }
        .thought-bubble:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 0;
            border: 15px solid transparent;
            border-top-color: #fff;
            border-bottom: 0;
            border-left-color: #fff;
            border-right-color: #fff;
            margin-left: -15px;
            margin-bottom: -15px;
            filter: drop-shadow(0 1px 0px #ccc);
        }
        .pizza-station {
            margin-top: 20px;
            min-height: 60px;
            border: 2px dashed #aaa;
            padding: 10px;
            border-radius: 5px;
            font-style: italic;
        }
        .pizza-item {
            display: inline-block;
            font-size: 2em;
            margin: 0 5px;
            animation: popIn 0.3s ease-out;
        }
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        #status-message {
            margin-top: 15px;
            font-weight: bold;
            color: #2c3e50;
            min-height: 20px;
        }
        .buttons-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 20px; /* Espacio antes de la explicaci√≥n */
        }
        button {
            padding: 10px 15px;
            font-size: 1em;
            background-color: #5cb85c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover:not(:disabled) {
            background-color: #4cae4c;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .step-explanation-box {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #333;
            color: #fff;
            padding: 15px 20px;
            box-sizing: border-box;
            text-align: center;
            font-size: 0.9em;
            border-top: 2px solid #5cb85c;
            min-height: 60px; /* Para asegurar que se vea algo incluso si no hay texto */
        }
        .step-explanation-box p {
            margin: 0;
        }
        .step-explanation-box strong {
            color: #5cb85c;
        }
    </style>
</head>
<body>
    <h1>Modelo de Concurrencia y Event Loop: El Chef As√≠ncrono (Paso a Paso con Explicaciones)</h1>

    <div class="container">
        <div class="chef-area">
            <h2>El Chef</h2>
            <div id="chef" class="chef-image">üßë‚Äçüç≥</div>
            <div id="thought-bubble" class="thought-bubble"></div>
            <div id="pizza-station" class="pizza-station">Mesa de preparaci√≥n vac√≠a...</div>
            <div id="status-message">Haz clic en "Preparar Pizza" para empezar.</div>
        </div>

        <div class="event-loop-visualizer">
            <div id="call-stack" class="box">
                <h3>Call Stack (Pila de Llamadas)</h3>
                <div class="placeholder">(Vac√≠o)</div>
            </div>
            <div id="web-apis" class="box">
                <h3>Web APIs (Ayudantes / Horno)</h3>
                <div class="placeholder">(Inactivo)</div>
            </div>
            <div id="callback-queue" class="box">
                <h3>Callback Queue (Cola de Tareas Listas)</h3>
                <div class="placeholder">(Vac√≠a)</div>
            </div>
        </div>
    </div>

    <div class="buttons-container">
        <button id="start-pizza-btn">Preparar Pizza</button>
        <button id="next-step-btn" disabled>Siguiente Paso</button>
        <button id="reset-btn" disabled>Reiniciar Simulaci√≥n</button>
    </div>

    <div id="step-explanation" class="step-explanation-box">
        <p>Haz clic en "Preparar Pizza" para iniciar la simulaci√≥n y ver las explicaciones aqu√≠.</p>
    </div>

    <script>
        const callStackDiv = document.getElementById('call-stack');
        const webApisDiv = document.getElementById('web-apis');
        const callbackQueueDiv = document.getElementById('callback-queue');
        const chefDiv = document.getElementById('chef');
        const thoughtBubbleDiv = document.getElementById('thought-bubble');
        const pizzaStationDiv = document.getElementById('pizza-station');
        const statusMessageDiv = document.getElementById('status-message');
        const startBtn = document.getElementById('start-pizza-btn');
        const nextStepBtn = document.getElementById('next-step-btn');
        const resetBtn = document.getElementById('reset-btn');
        const stepExplanationDiv = document.getElementById('step-explanation');

        const FLOUR_FETCH_TIME = 3000; // ms

        let currentStep = 0;
        let flourTimeoutId = null;

        const stepExplanations = [
            "Estado inicial. Esperando la orden del chef.", // Paso 0 (antes de iniciar)
            "<strong>Paso 1:</strong> Se llama a <code>prepararPizza()</code>. Esta funci√≥n se a√±ade al Call Stack. El chef empieza a trabajar.",
            "<strong>Paso 2:</strong> Dentro de <code>prepararPizza()</code>, se llama a <code>buscarHarina()</code>. Esta nueva funci√≥n se a√±ade encima en el Call Stack. El chef se da cuenta de que necesita harina.",
            "<strong>Paso 3:</strong> <code>buscarHarina()</code> necesita delegar la tarea de conseguir harina. Llama a <code>setTimeout(callbackHarinaLista, TIEMPO)</code>. <code>setTimeout</code> es una funci√≥n del navegador (Web API) que ejecutar√° <code>callbackHarinaLista</code> despu√©s de <code>TIEMPO</code> milisegundos. La llamada a <code>setTimeout</code> se a√±ade al Call Stack.",
            "<strong>Paso 4:</strong> La tarea <code>setTimeout(...)</code> se pasa al navegador (Web APIs) para que gestione el temporizador. Ya no est√° en el Call Stack. El ayudante (Web API) empieza a 'buscar harina'.",
            "<strong>Paso 5:</strong> La funci√≥n <code>buscarHarina()</code> ha terminado su trabajo inmediato (delegar) y se quita del Call Stack. El chef espera el resultado del ayudante.",
            "<strong>Paso 6:</strong> La funci√≥n <code>prepararPizza()</code> tambi√©n ha terminado su parte s√≠ncrona (ya deleg√≥ la harina) y se quita del Call Stack. El Call Stack est√° ahora vac√≠o. El chef est√° 'libre' para otras tareas, pero en esta simulaci√≥n, espera.",
            "<strong>Paso 7:</strong> El <strong>Event Loop</strong> comprueba constantemente. Si el Call Stack est√° vac√≠o y hay tareas en la Callback Queue, mueve la primera tarea de la Callback Queue al Call Stack. (Si la harina a√∫n no ha 'llegado' al Callback Queue, el Event Loop esperar√° al siguiente clic).",
            "<strong>Paso 8:</strong> (Asumiendo que la harina lleg√≥ y <code>callbackHarinaLista()</code> est√° en Call Stack) Se ejecuta <code>callbackHarinaLista()</code>. El chef recibe la harina y empieza a preparar la masa.",
            "<strong>Paso 9:</strong> <code>callbackHarinaLista()</code> contin√∫a. La masa est√° lista.",
            "<strong>Paso 10:</strong> Dentro de <code>callbackHarinaLista()</code>, se llama a <code>a√±adirIngredientes()</code> de forma s√≠ncrona. Esta funci√≥n se a√±ade al Call Stack. El chef a√±ade los ingredientes.",
            "<strong>Paso 11:</strong> <code>a√±adirIngredientes()</code> termina y se quita del Call Stack. La pizza est√° casi lista.",
            "<strong>Paso 12:</strong> <code>callbackHarinaLista()</code> ha terminado todo su trabajo y se quita del Call Stack. El Call Stack vuelve a estar vac√≠o. ¬°Pizza lista!"
        ];

        function updateStepExplanation(step) {
            stepExplanationDiv.innerHTML = `<p>${stepExplanations[step] || "Explicaci√≥n no disponible para este paso."}</p>`;
        }


        function updateBox(div, taskName, add = true, placeholderText = '(Vac√≠o)') {
            const placeholder = div.querySelector('.placeholder');
            if (placeholder) placeholder.style.display = 'none';

            if (add) {
                const taskElement = document.createElement('div');
                taskElement.className = 'task-item';
                taskElement.textContent = taskName;
                taskElement.id = 'task-' + taskName.replace(/[^\w]/g, '');
                if (!div.querySelector('#' + taskElement.id)) {
                    div.appendChild(taskElement);
                }
            } else {
                const taskElement = div.querySelector('#task-' + taskName.replace(/[^\w]/g, ''));
                if (taskElement) taskElement.remove();
            }

            if (div.querySelectorAll('.task-item').length === 0 && placeholder) {
                placeholder.style.display = 'block';
            }
        }

        function showThought(message) {
            thoughtBubbleDiv.textContent = message;
            thoughtBubbleDiv.style.display = 'block';
        }

        function hideThought() {
            thoughtBubbleDiv.style.display = 'none';
        }

        function setChefActive(active) {
            if (active) chefDiv.classList.add('active');
            else chefDiv.classList.remove('active');
        }
        
        function updateStatus(message) {
            statusMessageDiv.textContent = message;
        }

        function resetSimulation() {
            clearTimeout(flourTimeoutId);
            flourTimeoutId = null;
            
            ['call-stack', 'web-apis', 'callback-queue'].forEach(id => {
                const div = document.getElementById(id);
                div.innerHTML = `<h3>${div.querySelector('h3').textContent}</h3><div class="placeholder">${id === 'web-apis' ? '(Inactivo)' : '(Vac√≠o)'}</div>`;
            });
            pizzaStationDiv.innerHTML = 'Mesa de preparaci√≥n vac√≠a...';
            hideThought();
            setChefActive(false);
            updateStatus('Haz clic en "Preparar Pizza" para empezar.');
            
            startBtn.disabled = false;
            nextStepBtn.disabled = true;
            resetBtn.disabled = true;
            currentStep = 0;
            updateStepExplanation(0); // Explicaci√≥n inicial
        }
        
        function iniciarSimulacion() {
            resetSimulation();
            startBtn.disabled = true;
            nextStepBtn.disabled = false;
            resetBtn.disabled = false;
            currentStep = 0;
            ejecutarSiguientePaso(); // Llama al primer paso
        }

        function ejecutarSiguientePaso() {
            currentStep++;
            updateStepExplanation(currentStep); // Actualiza la explicaci√≥n ANTES de ejecutar la l√≥gica del paso

            switch (currentStep) {
                case 1:
                    updateStatus("Chef: ¬°Empezando la pizza!");
                    updateBox(callStackDiv, 'prepararPizza()', true);
                    setChefActive(true);
                    pizzaStationDiv.innerHTML = '<span class="pizza-item">üçï</span>';
                    break;
                case 2:
                    updateStatus("Chef: Leyendo receta... ¬°Necesito harina!");
                    updateBox(callStackDiv, 'buscarHarina()', true);
                    showThought("¬°Necesito Harina!");
                    break;
                case 3:
                    updateStatus("Chef: Mandando al ayudante por harina...");
                    updateBox(callStackDiv, 'setTimeout(callbackHarinaLista, ...)', true);
                    break;
                case 4:
                    updateStatus("Ayudante en camino por harina... (esto tomar√° " + FLOUR_FETCH_TIME/1000 + "s reales)");
                    updateBox(webApisDiv, 'Buscando Harina (' + FLOUR_FETCH_TIME/1000 + 's)', true);
                    updateBox(callStackDiv, 'setTimeout(callbackHarinaLista, ...)', false);
                    
                    flourTimeoutId = setTimeout(() => {
                        if (currentStep > 0) { 
                            updateBox(webApisDiv, 'Buscando Harina (' + FLOUR_FETCH_TIME/1000 + 's)', false);
                            updateStatus("Ayudante: ¬°Harina entregada a la cola de tareas!");
                            pizzaStationDiv.innerHTML = '<span class="pizza-item">üçï</span> <span class="pizza-item" style="font-size:1em; vertical-align:middle;">üõçÔ∏èüåæ</span>';
                            updateBox(callbackQueueDiv, 'callbackHarinaLista()', true);
                            hideThought();
                        }
                    }, FLOUR_FETCH_TIME);
                    break;
                case 5:
                    updateStatus("Chef: (Esperando que el ayudante regrese)... buscarHarina() termin√≥.");
                    updateBox(callStackDiv, 'buscarHarina()', false);
                    break;
                case 6:
                    updateStatus("Chef: (Esperando que el ayudante regrese)... prepararPizza() termin√≥ su parte s√≠ncrona.");
                    updateBox(callStackDiv, 'prepararPizza()', false);
                    setChefActive(false);
                    break;
                case 7:
                    updateStatus("Event Loop: Verificando Call Stack y Callback Queue...");
                    const callStackEmpty = callStackDiv.querySelectorAll('.task-item').length === 0;
                    const callbackQueueHasTasks = callbackQueueDiv.querySelectorAll('.task-item').length > 0;

                    if (callStackEmpty && callbackQueueHasTasks) {
                        const taskToMove = callbackQueueDiv.querySelector('.task-item');
                        updateStatus(`Event Loop: Call Stack vac√≠o. Moviendo '${taskToMove.textContent}' al Call Stack.`);
                        updateBox(callbackQueueDiv, taskToMove.textContent, false);
                        updateBox(callStackDiv, taskToMove.textContent, true);
                        updateStepExplanation(currentStep); // Reafirmar la explicaci√≥n de este paso si hay acci√≥n
                    } else if (callStackEmpty && !callbackQueueHasTasks) {
                        updateStatus("Event Loop: Call Stack vac√≠o, pero Callback Queue tambi√©n. Esperando tareas... (Clic en 'Siguiente Paso' cuando la harina haya llegado al Callback Queue)");
                         updateStepExplanation(currentStep); // Explicaci√≥n de espera
                        currentStep--; 
                    } else if (!callStackEmpty) {
                         updateStatus("Event Loop: Call Stack ocupado. Esperando...");
                         updateStepExplanation(currentStep); // Explicaci√≥n de espera
                         currentStep--; 
                    }
                    break;
                case 8:
                    setChefActive(true);
                    updateStatus("Chef: ¬°La harina ha llegado! A terminar la masa.");
                    pizzaStationDiv.innerHTML = '<span class="pizza-item">üçï</span> + <span class="pizza-item">üåæ</span>'; 
                    break;
                case 9:
                    updateStatus("Chef: ¬°Masa lista!");
                    pizzaStationDiv.innerHTML = '<span class="pizza-item">ü•Ø</span>';
                    break;
                case 10:
                    updateStatus("Chef: A√±adiendo ingredientes...");
                    updateBox(callStackDiv, 'a√±adirIngredientes()', true);
                    pizzaStationDiv.innerHTML = '<span class="pizza-item">ü•Ø</span> + <span class="pizza-item">üçÖ</span> + <span class="pizza-item">üßÄ</span>';
                    break;
                case 11:
                    updateStatus("Chef: ¬°Pizza lista para hornear! (Horneada m√°gicamente r√°pido)");
                    pizzaStationDiv.innerHTML = '<span class="pizza-item">üçï‚ú®</span>';
                    updateBox(callStackDiv, 'a√±adirIngredientes()', false);
                    break;
                case 12:
                    updateStatus("¬°Pizza Deliciosa Lista!");
                    updateBox(callStackDiv, 'callbackHarinaLista()', false);
                    setChefActive(false);
                    nextStepBtn.disabled = true;
                    resetBtn.disabled = false;
                    break;
                default:
                    updateStatus("Fin de la simulaci√≥n o paso desconocido.");
                    updateStepExplanation(0); // Volver a la explicaci√≥n inicial o una de fin.
                    nextStepBtn.disabled = true;
                    break;
            }
        }

        startBtn.addEventListener('click', iniciarSimulacion);
        nextStepBtn.addEventListener('click', ejecutarSiguientePaso);
        resetBtn.addEventListener('click', resetSimulation);

        resetSimulation(); // Estado inicial al cargar
    </script>
</body>
</html>